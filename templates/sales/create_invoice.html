{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow p-4">
    <h3 class="text-center mb-4">Create Invoice</h3>
    <form id="invoiceForm" method="POST">
      {% csrf_token %}
      <div class="row g-4">
        <!-- ================= LEFT SIDE ================= -->
        <div class="col-lg-8">
          <table class="table table-bordered table-sm align-middle" id="invoiceItemsTable">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th>Stock</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="itemRows">
              <tr>
                <td>
                  <select name="product" class="form-select form-select-sm productSelect">
                    <option value="">Select Item</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" data-price="{{ product.price }}" data-stock="{{ product.stock }}">
                      {{ product.name }}
                    </option>
                    {% endfor %}
                  </select>
                </td>
                <td><input type="number" class="form-control form-control-sm stockField" readonly></td>
                <td><input type="number" class="form-control form-control-sm priceField" value="0"></td>
                <td><input type="number" class="form-control form-control-sm qtyField" value="1" min="1"></td>
                <td><input type="number" class="form-control form-control-sm totalField" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm removeItem">X</button></td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn btn-primary btn-sm" id="addItemBtn">Add Item</button>
        </div>

        <!-- ================= RIGHT SIDE ================= -->
        <div class="col-lg-4">
          <div class="card p-3 border">
            <div class="mb-3">
              <label class="form-label fw-bold">Billed To:</label>
              <select id="customerSelect" name="customer" class="form-select form-select-sm">
                <option value="">Select Customer</option>
                {% for c in customers %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
              <a href="#" id="newCustomerLink" class="text-primary small">New Customer</a>

              <div id="newCustomerFields" class="mt-2" style="display:none;">
                <input type="text" name="new_customer_name" class="form-control form-control-sm mb-1" placeholder="Name">
                <input type="text" name="new_customer_phone" class="form-control form-control-sm mb-1" placeholder="Phone">
                <input type="text" name="new_customer_address" class="form-control form-control-sm" placeholder="Address">
                                 <a class="added-customer" style="cursor: pointer;">Existing Customer</a><br><br>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Payment Type:</label>
              <select id="paymentType" name="payment_type" class="form-select form-select-sm">
                <option value="Cash">Cash</option>
                <option value="Check">Check</option>
                <option value="Installment">Installment</option>
              </select>
            </div>

            <div id="bankSelectDiv" class="mb-3" style="display:none;">
              <label class="form-label fw-bold">Bank:</label>
              <select name="bank" class="form-select form-select-sm">
                {% for b in banks %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="border-top pt-2">
              <p class="mb-1"><strong>Total Qty:</strong> <span id="totalQty">0</span></p>
              <p class="mb-1"><strong>Grand Total:</strong> <span id="grandTotal">0.00</span></p>
            </div>

            <div class="border-top pt-2">
              <label>Discount</label>
              <input type="number" step="0.01" name="discount" class="form-control form-control-sm mb-1" value="0">
              <label>Shipping</label>
              <input type="number" step="0.01" name="shipping" class="form-control form-control-sm mb-1" value="0">
              <label>Paid Amount</label>
              <input type="number" step="0.01" name="paid_amount" class="form-control form-control-sm mb-1" value="0">
            </div>

            <div class="text-center mt-3">
              <button type="submit" class="btn btn-success w-100">Create Invoice</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- =============== JS =============== -->
<script>
document.addEventListener("DOMContentLoaded", function(){

  // Toggle New Customer Fields
  document.getElementById("newCustomerLink").addEventListener("click", function(e){
    e.preventDefault();
    document.getElementById("newCustomerFields").style.display = "block";
  });

  // Show/Hide Bank Selector
  document.getElementById("paymentType").addEventListener("change", function(){
    document.getElementById("bankSelectDiv").style.display = (this.value === "Check") ? "block" : "none";
  });

  // Add Item Row
  document.getElementById("addItemBtn").addEventListener("click", function(){
    let newRow = document.querySelector("#itemRows tr").cloneNode(true);
    newRow.querySelectorAll("input").forEach(i => i.value = "");
    document.getElementById("itemRows").appendChild(newRow);
  });

  // Remove Item Row
  document.addEventListener("click", function(e){
    if (e.target.classList.contains("removeItem")){
      e.target.closest("tr").remove();
      calculateTotals();
    }
  });

  // Update stock and price when product changes
  document.addEventListener("change", function(e){
    if (e.target.classList.contains("productSelect")){
      let option = e.target.options[e.target.selectedIndex];
      let stock = option.dataset.stock || 0;
      let price = option.dataset.price || 0;
      let row = e.target.closest("tr");
      row.querySelector(".stockField").value = stock;
      row.querySelector(".priceField").value = price;
      calculateTotals();
    }
  });

  // Update totals when qty or price changes
  document.addEventListener("input", function(e){
    if (e.target.classList.contains("qtyField") || e.target.classList.contains("priceField")){
      calculateTotals();
    }
  });

  function calculateTotals(){
    let rows = document.querySelectorAll("#itemRows tr");
    let totalQty = 0, grandTotal = 0;
    rows.forEach(r=>{
      let qty = parseFloat(r.querySelector(".qtyField").value) || 0;
      let price = parseFloat(r.querySelector(".priceField").value) || 0;
      let total = qty * price;
      r.querySelector(".totalField").value = total.toFixed(2);
      totalQty += qty;
      grandTotal += total;
    });
    document.getElementById("totalQty").textContent = totalQty.toFixed(0);
    document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
  }

});
</script>
{% endblock %}
